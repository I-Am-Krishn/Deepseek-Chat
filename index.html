<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Deepseek Studio ‚Äì Retro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://js.puter.com/v2/"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap');

    body {
      font-family: 'Space Grotesk', sans-serif;
      background-color: #f0fdf4; /* Light green tint */
      background-image: radial-gradient(#16a34a 1px, transparent 1px);
      background-size: 24px 24px;
    }

    /* Custom Scrollbar */
    .scroll-custom::-webkit-scrollbar { width: 8px; height: 8px; }
    .scroll-custom::-webkit-scrollbar-track { background: transparent; }
    .scroll-custom::-webkit-scrollbar-thumb { background: #000; border-radius: 99px; border: 2px solid #fff; }
    .scroll-custom::-webkit-scrollbar-thumb:hover { background: #333; }

    /* Neobrutalist Utilities */
    .neo-box {
      border: 3px solid #000;
      box-shadow: 4px 4px 0px 0px #000;
      transition: all 0.15s ease;
    }
    .neo-box:hover:not(:disabled) {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0px 0px #000;
    }
    .neo-box:active:not(:disabled) {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0px 0px #000;
    }
    .neo-static {
      border: 3px solid #000;
      box-shadow: 5px 5px 0px 0px #000;
    }
    .neo-input {
      border: 3px solid #000;
      box-shadow: 3px 3px 0px 0px #000;
      outline: none;
      transition: all 0.2s;
    }
    .neo-input:focus {
      transform: translate(-2px, -2px);
      box-shadow: 5px 5px 0px 0px #000;
    }

    /* Code Block Copy Button */
    .code-wrapper { position: relative; margin-top: 0.5rem; }
    .copy-code-btn {
      position: absolute; top: 0.5rem; right: 0.5rem;
      font-size: 0.7rem; font-weight: bold;
      background: #000; color: #fff;
      padding: 0.2rem 0.6rem; border-radius: 4px;
      opacity: 0.6; transition: opacity 0.2s;
    }
    .copy-code-btn:hover { opacity: 1; cursor: pointer; }

    /* Animations */
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .msg-animate { animation: slideUp 0.2s ease-out forwards; }

    /* Markdown Styles */
    .prose pre { margin: 0; border-radius: 0.5rem; overflow-x: auto; }
    .hljs { background: #111827; padding: 1rem; border-radius: 0.5rem; font-size: 0.85rem; line-height: 1.5; }
    .prose p { margin-bottom: 0.5rem; }
    .prose p:last-child { margin-bottom: 0; }
    .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }
    .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.5rem; }
    .prose code { background: rgba(0,0,0,0.1); padding: 0.1rem 0.3rem; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
  </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-gray-900">

  <header class="border-b-[3px] border-black bg-[#fff0c5] z-20">
    <div class="max-w-[1600px] mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-4">
      
      <div class="flex items-center gap-3">
        <div class="flex gap-1">
            <div class="w-3 h-3 rounded-full bg-[#ff6b6b] border-2 border-black"></div>
            <div class="w-3 h-3 rounded-full bg-[#feca57] border-2 border-black"></div>
            <div class="w-3 h-3 rounded-full bg-[#48dbfb] border-2 border-black"></div>
        </div>
        <div class="flex flex-col leading-none">
            <h1 class="text-xl font-black tracking-tight uppercase">Deepseek<span class="text-purple-600">Chat</span></h1>
            <span class="text-[10px] font-bold text-gray-600 uppercase tracking-widest">Retro Studio</span>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="hidden md:flex items-center px-3 py-1 bg-white border-2 border-black rounded-full shadow-[2px_2px_0_#000]">
            <span class="text-xs font-bold">by <span class="text-purple-600">I-Am-Krishn</span></span>
        </div>

        <a href="https://ko-fi.com/iamkrishn" target="_blank" class="hidden sm:flex neo-box bg-[#ff9ff3] px-3 py-1 rounded-full text-xs font-bold items-center gap-2 text-black no-underline hover:bg-[#fd79a8]">
            <span>‚òï Support</span>
        </a>

        <button id="connect-btn" class="neo-box bg-white px-4 py-1.5 rounded-full font-bold text-xs flex items-center gap-2 transition-colors">
          <div id="connection-dot" class="w-2.5 h-2.5 bg-red-500 rounded-full border border-black"></div>
          <span id="connection-label">Connect</span>
        </button>
      </div>
    </div>
  </header>

  <main class="flex-1 flex overflow-hidden max-w-[1600px] mx-auto w-full p-2 md:p-4 gap-4">
    
    <aside class="hidden md:flex flex-col w-72 gap-4 shrink-0">
      
      <div class="neo-static bg-[#a29bfe] p-4 flex flex-col gap-4 rounded-xl h-fit">
        <h2 class="font-black text-sm uppercase border-b-2 border-black pb-2 flex justify-between">
            <span>Setup</span>
            <span>‚öôÔ∏è</span>
        </h2>
        
        <div class="space-y-1">
          <label class="text-[10px] font-bold uppercase tracking-wider">Model</label>
          <div class="relative">
            <select id="model-select" class="neo-input w-full bg-white px-2 py-2 font-bold text-xs rounded-lg appearance-none cursor-pointer">
                <option value="deepseek-chat">deepseek-chat (V3)</option>
                <option value="deepseek-reasoner">deepseek-reasoner (R1)</option>
            </select>
            <div class="absolute right-2 top-2.5 pointer-events-none text-xs">‚ñº</div>
          </div>
        </div>

        <div class="space-y-1">
          <label class="text-[10px] font-bold uppercase tracking-wider">Persona</label>
          <div class="relative">
            <select id="persona-select" class="neo-input w-full bg-white px-2 py-2 font-bold text-xs rounded-lg appearance-none cursor-pointer">
                <option value="default">Default Assistant</option>
                <option value="senior-dev">Senior Developer</option>
                <option value="teacher">Teacher</option>
                <option value="pm">Product Manager</option>
                <option value="prompt-engineer">Prompt Engineer</option>
            </select>
            <div class="absolute right-2 top-2.5 pointer-events-none text-xs">‚ñº</div>
          </div>
        </div>

        <div class="space-y-1">
            <label class="text-[10px] font-bold uppercase tracking-wider">Session Goal</label>
            <input id="goal-input" type="text" placeholder="e.g. 'Learn React'" class="neo-input w-full bg-white px-2 py-2 font-bold text-xs rounded-lg">
        </div>
      </div>

      <div class="neo-static bg-[#fab1a0] p-4 flex flex-col gap-3 rounded-xl h-fit mt-auto">
        <div class="flex justify-between items-end border-b-2 border-black pb-2">
          <span class="text-[10px] font-bold uppercase">Total Messages</span>
          <span class="font-black text-2xl leading-none"><span id="session-count">0</span><span class="text-sm text-gray-600 font-medium">/100k</span></span>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <button id="clear-chat" class="neo-box bg-white py-1.5 rounded-lg text-[10px] font-bold uppercase hover:bg-red-100">Clear Chat</button>
          <button id="export-chat" class="neo-box bg-white py-1.5 rounded-lg text-[10px] font-bold uppercase hover:bg-blue-100">Export JSON</button>
        </div>
      </div>
    </aside>

    <section class="flex-1 flex flex-col min-w-0 h-full">
      <div class="neo-static flex-1 flex flex-col bg-[#fdfbf7] rounded-xl overflow-hidden relative">
        
        <div id="chat-window" class="flex-1 overflow-y-auto scroll-custom p-4 space-y-6 pb-24">
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center opacity-40">
                <div class="text-5xl mb-2">üí¨</div>
                <p class="font-bold font-mono">NO MESSAGES YET</p>
            </div>
        </div>

        <div id="typing-indicator" class="hidden absolute bottom-[5.5rem] left-6 z-10">
          <div class="bg-black text-white text-[10px] font-bold px-3 py-1.5 rounded-full flex items-center gap-1.5 shadow-[3px_3px_0_rgba(0,0,0,0.2)]">
            <div class="flex gap-0.5">
                <span class="w-1 h-1 bg-white rounded-full animate-bounce"></span>
                <span class="w-1 h-1 bg-white rounded-full animate-bounce delay-75"></span>
                <span class="w-1 h-1 bg-white rounded-full animate-bounce delay-150"></span>
            </div>
            <span class="uppercase tracking-wider">Deepseek is thinking</span>
          </div>
        </div>

        <div class="bg-[#dfe6e9] border-t-[3px] border-black p-3 md:p-4">
          <form id="chat-form" class="flex gap-3 items-end relative">
            <textarea 
              id="prompt-input" 
              rows="1" 
              placeholder="Type your prompt here..." 
              class="neo-input flex-1 bg-white p-3 rounded-xl resize-none min-h-[54px] max-h-[160px] font-medium text-sm leading-relaxed"
              style="border-radius: 12px;"
              oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 160) + 'px'"
            ></textarea>
            
            <button id="send-btn" type="submit" disabled class="neo-box h-[54px] w-[54px] shrink-0 bg-[#00b894] text-black rounded-xl flex items-center justify-center disabled:bg-gray-300 disabled:border-gray-500 disabled:shadow-none disabled:translate-x-0 disabled:translate-y-0 transition-all">
                <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                </svg>
                <svg id="send-spinner" class="hidden w-5 h-5 animate-spin text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
          </form>
          <div class="text-[10px] font-bold text-gray-500 mt-2 flex justify-between px-1 uppercase tracking-wider">
            <span>Enter = Send ‚Ä¢ Shift+Enter = New Line</span>
            <span id="status-text">Not Connected</span>
          </div>
        </div>
      </div>
    </section>

    <aside class="hidden lg:flex flex-col w-80 gap-4 shrink-0">
      <div class="neo-static flex-1 bg-white rounded-xl overflow-hidden flex flex-col">
        
        <div class="border-b-2 border-black bg-[#ffeaa7] py-3 px-4 flex items-center justify-between">
            <span class="text-[10px] font-black uppercase tracking-widest">Topic Map</span>
            <button id="generate-topics" class="neo-box bg-black text-white px-3 py-1 rounded text-[9px] font-bold uppercase hover:bg-gray-800">
                Generate
            </button>
        </div>
        
        <div class="flex-1 p-4 overflow-y-auto scroll-custom bg-white flex-col">
            <div id="topics-status" class="hidden text-xs font-bold text-purple-600 mb-2 animate-pulse">
                Generating analysis...
            </div>
            <div id="topics-content" class="prose prose-sm prose-p:text-xs prose-li:text-xs prose-headings:text-sm">
                <p class="text-gray-400 text-xs italic text-center mt-10">
                    Chat with Deepseek, then click <strong>Generate</strong> to create a summary mindmap of the conversation.
                </p>
            </div>
        </div>
      </div>
    </aside>
  </main>

  <script>
    // ===== CONFIGURATION =====
    const CONFIG = {
        MAX_MESSAGES: 100000,
        CONTEXT_MESSAGES: 80,
        STORAGE_KEY: 'deepseek_retro_studio_v3_clean'
    };

    // ===== STATE MANAGEMENT =====
    let state = {
        messages: [],
        nextId: 1,
        isConnected: false,
        isGenerating: false
    };

    // ===== DOM ELEMENTS =====
    const el = (id) => document.getElementById(id);
    const ui = {
        chatWindow: el('chat-window'),
        emptyState: el('empty-state'),
        input: el('prompt-input'),
        form: el('chat-form'),
        sendBtn: el('send-btn'),
        sendIcon: el('send-icon'),
        sendSpinner: el('send-spinner'),
        typing: el('typing-indicator'),
        connectBtn: el('connect-btn'),
        connDot: el('connection-dot'),
        connLabel: el('connection-label'),
        statusText: el('status-text'),
        count: el('session-count'),
        model: el('model-select'),
        persona: el('persona-select'),
        goal: el('goal-input'),
        topicContent: el('topics-content'),
        topicStatus: el('topics-status'),
        genTopicBtn: el('generate-topics'),
        clearBtn: el('clear-chat'),
        exportBtn: el('export-chat')
    };

    // ===== CORE LOGIC =====

    // 1. Initialization
    function init() {
        loadSession();
        renderMessages();
        updateConnectionUI();
    }

    // 2. Helper: Build Persona Text
    function buildPersonaPrefix() {
        const p = ui.persona.value;
        if (p === 'senior-dev') return 'You are a senior software engineer. Be precise, pragmatic and include code when helpful.\n';
        if (p === 'teacher') return 'You are a patient teacher. Explain concepts clearly with simple examples.\n';
        if (p === 'pm') return 'You are a product thinker. Focus on user impact, UX and tradeoffs.\n';
        if (p === 'prompt-engineer') return 'You are an expert prompt engineer. Optimize and refactor prompts.\n';
        return ''; // Default
    }

    function buildContextPrompt(userPrompt) {
        const persona = buildPersonaPrefix();
        const goal = ui.goal.value ? `The user's current session goal is: "${ui.goal.value}". Align answers with this goal.\n` : '';
        
        const recent = state.messages.slice(-CONFIG.CONTEXT_MESSAGES);
        const lines = [];
        
        if(persona || goal) lines.push(persona + goal);
        if(recent.length) {
            lines.push('Conversation so far:');
            recent.forEach(m => lines.push(`${m.role === 'user' ? 'User' : 'Assistant'}: ${m.text}`));
        }
        lines.push('User: ' + userPrompt);
        lines.push('Assistant:');
        return lines.join('\n');
    }

    // 3. Connection
    async function connect() {
        if (state.isConnected) return;
        
        ui.connLabel.textContent = "Connecting...";
        ui.connectBtn.disabled = true;

        try {
            await puter.ai.chat('ping', { model: 'deepseek-chat', stream: true });
            state.isConnected = true;
        } catch (e) {
            console.error(e);
            alert("Connection failed. Ensure you are logged into Puter.js");
        } finally {
            ui.connectBtn.disabled = false;
            updateConnectionUI();
        }
    }

    function updateConnectionUI() {
        if (state.isConnected) {
            ui.connDot.classList.replace('bg-red-500', 'bg-green-500');
            ui.connLabel.textContent = "Connected";
            ui.statusText.textContent = "Online & Ready";
            ui.sendBtn.disabled = false;
        } else {
            ui.connDot.classList.replace('bg-green-500', 'bg-red-500');
            ui.connLabel.textContent = "Connect";
            ui.statusText.textContent = "Not Connected";
            ui.sendBtn.disabled = true;
        }
    }

    // 4. Messaging & Rendering
    function addMessage(role, text) {
        const msg = { id: state.nextId++, role, text, ts: Date.now() };
        state.messages.push(msg);
        if (state.messages.length > CONFIG.MAX_MESSAGES) state.messages.shift();
        saveSession();
        return msg;
    }

    // Code Highlighter & Copy Button Injection
    function enhanceCodeBlocks(container) {
        container.querySelectorAll('pre code').forEach(codeEl => {
            hljs.highlightElement(codeEl);
            const pre = codeEl.parentElement;
            
            if (!pre.parentElement.classList.contains('code-wrapper')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'code-wrapper';
                pre.parentElement.insertBefore(wrapper, pre);
                wrapper.appendChild(pre);
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-code-btn';
                copyBtn.textContent = 'Copy Code';
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(codeEl.textContent);
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => copyBtn.textContent = 'Copy Code', 1500);
                };
                wrapper.appendChild(copyBtn);
            }
        });
    }

    function createMessageElement(msg) {
        const isUser = msg.role === 'user';
        const div = document.createElement('div');
        div.className = `flex w-full msg-animate ${isUser ? 'justify-end' : 'justify-start'}`;
        
        const bubbleColor = isUser ? 'bg-[#fab1a0]' : 'bg-white'; 
        
        div.innerHTML = `
            <div class="max-w-[90%] md:max-w-[80%] flex flex-col gap-1 ${isUser ? 'items-end' : 'items-start'} group">
                <div class="flex items-center gap-2 px-1">
                    <span class="text-[10px] font-bold uppercase tracking-wider text-gray-500">${isUser ? 'You' : 'Deepseek'}</span>
                    <span class="text-[9px] text-gray-400">${new Date(msg.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    <button class="hidden group-hover:block text-[9px] border border-black bg-white px-1 rounded hover:bg-gray-100" onclick="copyText(this)">COPY</button>
                </div>
                <div class="msg-content prose prose-sm max-w-none ${bubbleColor} border-[3px] border-black shadow-[4px_4px_0_#000] rounded-xl p-3 md:p-4 text-sm overflow-hidden">
                    ${marked.parse(msg.text)}
                </div>
            </div>
        `;
        
        enhanceCodeBlocks(div);
        return div;
    }

    window.copyText = function(btn) {
        const text = btn.closest('.group').querySelector('.msg-content').innerText;
        navigator.clipboard.writeText(text);
        btn.textContent = 'OK';
        setTimeout(() => btn.textContent = 'COPY', 1000);
    }

    function renderMessages() {
        ui.chatWindow.innerHTML = '';
        if (state.messages.length === 0) {
            ui.chatWindow.appendChild(ui.emptyState);
        } else {
            state.messages.forEach(m => ui.chatWindow.appendChild(createMessageElement(m)));
        }
        ui.count.textContent = state.messages.length;
        scrollToBottom();
    }

    function scrollToBottom() {
        ui.chatWindow.scrollTop = ui.chatWindow.scrollHeight;
    }

    // 5. Sending Logic
    async function handleSend(e) {
        e.preventDefault();
        if (!state.isConnected) return alert("Please connect first.");
        
        const text = ui.input.value.trim();
        if (!text) return;

        ui.input.value = '';
        ui.input.style.height = '54px';

        addMessage('user', text);
        renderMessages();

        ui.typing.classList.remove('hidden');
        ui.sendIcon.classList.add('hidden');
        ui.sendSpinner.classList.remove('hidden');
        ui.sendBtn.disabled = true;

        const aiMsg = addMessage('assistant', '');
        renderMessages();

        try {
            const prompt = buildContextPrompt(text);
            const stream = await puter.ai.chat(prompt, { 
                model: ui.model.value, 
                stream: true 
            });

            let fullText = '';
            for await (const part of stream) {
                fullText += part?.text || '';
                aiMsg.text = fullText;
                
                const bubbles = ui.chatWindow.querySelectorAll('.msg-content');
                const lastBubble = bubbles[bubbles.length - 1];
                if (lastBubble) {
                    lastBubble.innerHTML = marked.parse(fullText);
                    enhanceCodeBlocks(lastBubble.parentElement);
                }
                scrollToBottom();
            }
            saveSession();

        } catch (err) {
            aiMsg.text = `**Error:** ${err.message}`;
            renderMessages();
        } finally {
            ui.typing.classList.add('hidden');
            ui.sendIcon.classList.remove('hidden');
            ui.sendSpinner.classList.add('hidden');
            ui.sendBtn.disabled = false;
        }
    }

    // 6. Topic Generation
    async function generateTopics() {
        if (!state.messages.length) return;
        if (!state.isConnected) return alert("Connect first.");
        
        ui.topicStatus.classList.remove('hidden');
        ui.topicContent.innerHTML = '';
        
        const text = state.messages.slice(-20).map(m => m.text).join('\n');
        const prompt = "Analyze this conversation and create a concise markdown mindmap/list of main topics. Use bullet points.";
        
        try {
            const resp = await puter.ai.chat(`${prompt}\n\n${text}`, { model: 'deepseek-chat' });
            ui.topicContent.innerHTML = marked.parse(resp.message.content || resp.toString());
        } catch (e) {
            ui.topicContent.innerHTML = "Failed to generate topics.";
        } finally {
            ui.topicStatus.classList.add('hidden');
        }
    }

    // 7. Storage
    function saveSession() {
        const data = {
            messages: state.messages,
            persona: ui.persona.value,
            goal: ui.goal.value
        };
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(data));
    }

    function loadSession() {
        try {
            const raw = localStorage.getItem(CONFIG.STORAGE_KEY);
            if (raw) {
                const data = JSON.parse(raw);
                state.messages = data.messages || [];
                state.nextId = state.messages.length ? Math.max(...state.messages.map(m=>m.id)) + 1 : 1;
                if(data.persona) ui.persona.value = data.persona;
                if(data.goal) ui.goal.value = data.goal;
            }
        } catch (e) { console.warn("Load error", e); }
    }

    // ===== EVENTS =====
    ui.connectBtn.onclick = connect;
    ui.form.onsubmit = handleSend;
    
    ui.input.onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            ui.form.dispatchEvent(new Event('submit'));
        }
    };

    ui.clearBtn.onclick = () => {
        if(confirm("Delete all messages?")) {
            state.messages = [];
            renderMessages();
            saveSession();
        }
    };

    ui.exportBtn.onclick = () => {
        const blob = new Blob([JSON.stringify(state.messages, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'deepseek-session.json';
        a.click();
    };

    ui.genTopicBtn.onclick = generateTopics;
    ui.model.onchange = saveSession;
    ui.persona.onchange = saveSession;
    ui.goal.onchange = saveSession;

    // Run
    init();

  </script>
</body>
</html>
